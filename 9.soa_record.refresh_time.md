# Task #9 - soa_record.refresh_time

## Summary
Implemented the `refresh_time` argument within the `soa_record` block as part of the post-creation operation. The field is optional with a default of 3600 and validation requiring a non-negative integer value.

## Shadow Implementation
```hcl
# In migrate_main.tf
locals {
  post_creation0 = var.soa_record != null ? {
    azapi_header = {
      type = "Microsoft.Network/privateDnsZones/SOA@2024-06-01"
    }
    body = {
      properties = {
        # ttl = ... # Task #11
        soaRecord = {
          email       = var.soa_record.email
          expireTime  = var.soa_record.expire_time
          minimumTtl  = var.soa_record.minimum_ttl
          refreshTime = var.soa_record.refresh_time # <-
          # retryTime = ... # Task #10
        }
        # metadata = ... # Task #12
      }
    }
    locks = local.locks
  } : null
}
```

```hcl
# In variables.tf
variable "soa_record" {
  type = object({
    email        = string
    expire_time  = optional(number, 2419200)
    minimum_ttl  = optional(number, 10)
    refresh_time = optional(number, 3600) # <-
    retry_time   = optional(number, 300)
    tags         = optional(map(string))
    ttl          = optional(number, 3600)
  })
  default     = null
  description = <<-EOT
   - `email` - (Required) The email contact for the SOA record.
   - `expire_time` - (Optional) The expire time for the SOA record. Defaults to `2419200`.
   - `minimum_ttl` - (Optional) The minimum Time To Live for the SOA record. By convention, it is used to determine the negative caching duration. Defaults to `10`.
   - `refresh_time` - (Optional) The refresh time for the SOA record. Defaults to `3600`. # <-
   - `retry_time` - (Optional) The retry time for the SOA record. Defaults to `300`.
   - `tags` - (Optional) A mapping of tags to assign to the Record Set.
   - `ttl` - (Optional) The Time To Live of the SOA Record in seconds. Defaults to `3600`.
EOT

  # ... other validations ...

  validation { # <-
    condition = var.soa_record == null || ( # <-
      var.soa_record.refresh_time >= 0 # <-
    ) # <-
    error_message = "The `refresh_time` must be at least 0." # <-
  } # <-
}
```

## Create Phase Verification

### Pattern: Post-Creation Operation
The `refresh_time` field is part of the `soa_record` block, which is implemented as a post-creation operation (`post_creation0`) as documented in Task #5.

### Evidence from Create Method
From `resourcePrivateDnsZoneCreateUpdate`:

```go
// Phase 1: Primary zone creation
if err := client.CreateOrUpdateThenPoll(ctx, id, parameters, options); err != nil {
    return fmt.Errorf("creating/updating %s: %s", id, err)
}

// Phase 2: SOA record post-creation operation
if v, ok := d.GetOk("soa_record"); ok {
    soaRecordRaw := v.([]interface{})[0].(map[string]interface{})
    soaRecord := expandPrivateDNSZoneSOARecord(soaRecordRaw)  // <-- refresh_time processed here
    rsParameters := privatedns.RecordSet{
        Properties: &privatedns.RecordSetProperties{
            Ttl:       pointer.To(int64(soaRecordRaw["ttl"].(int))),
            Metadata:  tags.Expand(soaRecordRaw["tags"].(map[string]interface{})),
            SoaRecord: soaRecord,  // <-- Contains RefreshTime
        },
    }

    recordId := privatedns.NewRecordTypeID(id.SubscriptionId, id.ResourceGroupName, id.PrivateDnsZoneName, privatedns.RecordTypeSOA, "@")

    // ... validation ...

    if _, err := recordSetsClient.RecordSetsCreateOrUpdate(ctx, recordId, rsParameters, createOptions); err != nil {
        return fmt.Errorf("creating/updating %s: %s", recordId, err)
    }
}
```

### SDK Function Classification
- **Primary Operation**: `client.CreateOrUpdateThenPoll()` - Creates Private DNS Zone
- **Post-Operation**: `recordSetsClient.RecordSetsCreateOrUpdate()` - CreateOrUpdate function for SOA record
- **Classification**: Post-creation operation → `post_creation0` (index 0)

### Decision
The `refresh_time` field is processed in the post-creation phase, not during primary zone creation. It's included in the `expandPrivateDNSZoneSOARecord` function and assigned to the SOA record via `RecordSetsCreateOrUpdate` API call.

## Assignment Path Verification

### Predicted Path
`body.properties.soaRecord.refreshTime`

### Go Code Evidence
From `expandPrivateDNSZoneSOARecord`:
```go
func expandPrivateDNSZoneSOARecord(input map[string]interface{}) *privatedns.SoaRecord {
    return &privatedns.SoaRecord{
        Email:       pointer.To(input["email"].(string)),
        ExpireTime:  pointer.To(int64(input["expire_time"].(int))),
        MinimumTtl:  pointer.To(int64(input["minimum_ttl"].(int))),
        RefreshTime: pointer.To(int64(input["refresh_time"].(int))),  // <-- FIELD ASSIGNMENT
        RetryTime:   pointer.To(int64(input["retry_time"].(int))),
    }
}
```

From Create method:
```go
rsParameters := privatedns.RecordSet{
    Properties: &privatedns.RecordSetProperties{  // <-- .Properties assignment adds nesting
        Ttl:       pointer.To(int64(soaRecordRaw["ttl"].(int))),
        Metadata:  tags.Expand(soaRecordRaw["tags"].(map[string]interface{})),
        SoaRecord: soaRecord,  // <-- .SoaRecord nested under Properties
    },
}
```

### Verified Path
1. `RecordSet` struct → `.Properties` → `RecordSetProperties`
2. Within `RecordSetProperties` → `.SoaRecord` → `SoaRecord`
3. Within `SoaRecord` → `.RefreshTime` (int64 pointer)

**Azure API Path**: `body.properties.soaRecord.refreshTime`

### Path Comparison
✅ **Match**: The predicted path and verified path are identical. The field assignment follows:
- `input["refresh_time"]` → `SoaRecord.RefreshTime` → `RecordSetProperties.SoaRecord` → `RecordSet.Properties` → API body at `properties.soaRecord.refreshTime`

## Provider Schema

### Schema Definition
From the resource schema:
```go
"refresh_time": {
    Type:         pluginsdk.TypeInt,
    Optional:     true,
    Default:      3600,
    ValidateFunc: validation.IntAtLeast(0),
},
```

### Key Properties
- **Type**: Int
- **Optional**: true
- **Default**: 3600
- **ValidateFunc**: `validation.IntAtLeast(0)` - must be non-negative integer

## Azure API Schema

### Resource Type
`Microsoft.Network/privateDnsZones/SOA@2024-06-01`

### Property Path
`body.properties.soaRecord.refreshTime`

### Schema Type
From Azure API query result:
```
"soaRecord":ObjectWithOptionalAttrs(map[string]Type{
    "email":String, 
    "expireTime":Number, 
    "host":String, 
    "minimumTtl":Number, 
    "refreshTime":Number,  // <-- Number type
    "retryTime":Number, 
    "serialNumber":Number
}, ...)
```

**Type**: Number (maps to int64 in Go SDK)

### Azure API Documentation
From Azure API for `refreshTime`:
- "The refresh value for this SOA record."
- Represents how often secondary name servers should check for updates from the primary name server

## Hidden Fields Check

### Analysis
From the expand function:
```go
func expandPrivateDNSZoneSOARecord(input map[string]interface{}) *privatedns.SoaRecord {
    return &privatedns.SoaRecord{
        Email:       pointer.To(input["email"].(string)),
        ExpireTime:  pointer.To(int64(input["expire_time"].(int))),
        MinimumTtl:  pointer.To(int64(input["minimum_ttl"].(int))),
        RefreshTime: pointer.To(int64(input["refresh_time"].(int))),
        RetryTime:   pointer.To(int64(input["retry_time"].(int))),
    }
}
```

### Hidden Fields Found
**None** - The field is mapped directly from schema input to API field with type conversion only:
- Schema: `int` → Go: `int64` via type cast → API: `Number`
- No hidden fields added
- No additional logic or transformations

## Mapping (snake_case → camelCase)

| Schema Field | API Field | Notes |
|--------------|-----------|-------|
| `refresh_time` | `refreshTime` | Type conversion: int → int64 |

## Special Handling

### 1. Default Value
The field has a default value of 3600 seconds (1 hour).

**Implementation**: Using Terraform's `optional()` type constructor:
```hcl
refresh_time = optional(number, 3600)
```

This approach:
- ✅ Applies default when field is not specified
- ✅ Avoids need for conditional logic in locals
- ✅ Matches provider behavior exactly

### 2. Validation
The provider schema includes `validation.IntAtLeast(0)`.

**Implementation in variables.tf**:
```hcl
validation {
  condition = var.soa_record == null || (
    var.soa_record.refresh_time >= 0
  )
  error_message = "The `refresh_time` must be at least 0."
}
```

**Rationale**:
- ✅ Replicates provider's `IntAtLeast(0)` validation exactly
- ✅ Validates at plan time, not during API call
- ✅ Null-safe: only validates when `soa_record` block is set
- ✅ Clear error message matching provider behavior

### 3. Type Conversion
Provider converts from Terraform `int` to Go `int64`:
```go
RefreshTime: pointer.To(int64(input["refresh_time"].(int)))
```

**Implementation**: Direct assignment - Terraform handles numeric type compatibility:
```hcl
refreshTime = var.soa_record.refresh_time
```

**Why this works**:
- ✅ AzAPI provider 2.0+ accepts native Terraform types
- ✅ Terraform's `number` type is compatible with Azure API's `Number` schema
- ✅ No explicit type conversion needed in HCL

### 4. Parent Block Context
The field is only processed when parent `soa_record` block is not null:
- When `var.soa_record == null`: Entire `post_creation0` is null, no SOA record operation
- When `var.soa_record != null`: Full structure created, `refresh_time` assigned with default if not specified

## Deferred Work Completion

### Check for Deferred Work
Checked `following.md` for any work deferred to Task #9.

**Result**: File does not exist - no deferred work to complete.

## Edge Case Analysis

### Null Semantics
- **`var.soa_record == null`**: Field not applicable, no SOA record customization
- **`var.soa_record.refresh_time` not set**: Default of 3600 applied via `optional(number, 3600)`
- **`var.soa_record.refresh_time` explicitly set**: User-provided value used

### Boundary Conditions
- **Minimum value**: 0 (validated)
- **Maximum value**: Terraform `number` type supports large integers (Go int64 range: -9223372036854775808 to 9223372036854775807)
- **Default value**: 3600 seconds (1 hour) - standard DNS refresh interval
- **Typical range**: DNS refresh times typically range from 1800 (30 min) to 86400 (24 hours)

### Type Safety
- ✅ Terraform enforces `number` type
- ✅ Validation ensures non-negative
- ✅ Default value is within valid range
- ✅ Azure API accepts Number type (int64)

### Idempotency
- ✅ Same input produces same output
- ✅ Default value is stable across applies
- ✅ No order-dependent logic
- ✅ Direct value assignment (no transformations)

### Safe References
- ✅ `var.soa_record.refresh_time` accessed only when `var.soa_record != null` (outer conditional in `post_creation0`)
- ✅ Type-safe: field defined in object schema with default
- ✅ Validation is null-safe with `var.soa_record == null ||` guard

## Critical Review

### Exact Provider Behavior Replication
✅ **Default value**: Matches provider's `Default: 3600`
✅ **Validation**: Replicates `validation.IntAtLeast(0)` exactly
✅ **Type handling**: Matches provider's int to int64 conversion pattern
✅ **Post-creation context**: Correctly placed in `post_creation0.body.properties.soaRecord`
✅ **Null safety**: Parent block conditional ensures safe access

### No Simplified/Conservative Approaches
- ❌ Did NOT simplify validation (kept exact IntAtLeast(0) logic)
- ❌ Did NOT change default value for "safety"
- ❌ Did NOT add extra validations not in provider
- ❌ Did NOT use different placement in structure

### Completeness
- ✅ Field added to correct location in skeleton
- ✅ Default value applied via `optional()` syntax
- ✅ Validation added to `variables.tf`
- ✅ No hidden fields to add
- ✅ No cross-field validations involving this field
- ✅ No ForceNew tracking needed (parent block is ForceNew)

### Provider Behavior Match
From provider code:
```go
"refresh_time": {
    Type:         pluginsdk.TypeInt,
    Optional:     true,
    Default:      3600,
    ValidateFunc: validation.IntAtLeast(0),
}
```

Implementation matches:
- ✅ Optional field with default
- ✅ IntAtLeast(0) validation replicated
- ✅ Type: number (compatible with int)
- ✅ Processed in expand function exactly as provider does

## Checklist

- ✅ Property in correct local (`post_creation0.body.properties.soaRecord.refreshTime`)
- ✅ ForceNew handled by parent block (Task #5)
- ✅ All logic exactly replicated from provider (default, validation, type conversion)
- ✅ Validation implemented in variables.tf (IntAtLeast(0))
- ✅ No TODO comments needed (field implementation complete, not migration to independent var)
- ✅ Hidden fields checked - none found
- ✅ No work deferred to other tasks
- ✅ No deferred work from following.md to complete
- ✅ Critical review completed - null safety, idempotency, type safety verified
- ✅ Edge Case Analysis included
- ✅ Proof document created
- ✅ Ready to update track.md to "Pending for check"
- ✅ Self-Review: Only `refresh_time` field implemented, replaced comment placeholder, no other fields touched

## Implementation Verification

### Files Modified
1. **migrate_main.tf**: Replaced `# refreshTime = ... # Task #9` with `refreshTime = var.soa_record.refresh_time`
2. **variables.tf**: Added validation block for `refresh_time >= 0`

### Code Changes
**Before** (migrate_main.tf):
```hcl
soaRecord = {
  email      = var.soa_record.email
  expireTime = var.soa_record.expire_time
  minimumTtl = var.soa_record.minimum_ttl
  # refreshTime = ... # Task #9
  # retryTime = ... # Task #10
}
```

**After** (migrate_main.tf):
```hcl
soaRecord = {
  email       = var.soa_record.email
  expireTime  = var.soa_record.expire_time
  minimumTtl  = var.soa_record.minimum_ttl
  refreshTime = var.soa_record.refresh_time
  # retryTime = ... # Task #10
}
```

**Added** (variables.tf):
```hcl
validation {
  condition = var.soa_record == null || (
    var.soa_record.refresh_time >= 0
  )
  error_message = "The `refresh_time` must be at least 0."
}
```

### Exact Replication Confirmation
This implementation EXACTLY replicates the provider behavior:
1. ✅ Same default value (3600)
2. ✅ Same validation (IntAtLeast 0)
3. ✅ Same type handling (number/int)
4. ✅ Same assignment path (properties.soaRecord.refreshTime)
5. ✅ Same processing phase (post-creation)

No "more conservative" or "simpler" approaches were taken. The implementation is a precise replication of the provider's behavior.

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2025-12-23
**Task:** #9 - soa_record.refresh_time

### Validation Results

✅ **ForceNew Logic:** Inherited from parent block (Task #5) - no separate tracking needed
✅ **Stable Keys:** Key always present when parent block exists - no conditional appearance/disappearance
✅ **Phase Detection:** Correctly identified as post-creation operation (`post_creation0`)
✅ **Type Conversion:** Correct conversion from Terraform `number` to Azure API `Number`
✅ **Null Handling:** Safe references with proper conditional guards throughout
✅ **Validations:** Exact replication of provider's `validation.IntAtLeast(0)` implemented in variables.tf
✅ **Default Value:** Using preferred `optional(number, 3600)` method as per executor.md line 148
✅ **Assignment Path:** Exact match - `post_creation0.body.properties.soaRecord.refreshTime`
✅ **Deferred Work Completion:** No deferred work for this task (no following.md)
✅ **Deferred Work Recording:** No deferrals made
✅ **Edge Cases:** All edge cases properly analyzed - null semantics, boundary conditions, idempotency verified

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. The field:
- Uses the **preferred method** for defaults (`optional(number, 3600)` per executor.md line 148)
- Implements **exact validation** from provider schema (`IntAtLeast(0)`)
- Is **correctly placed** in post-creation operation structure
- Has **proper null safety** with parent block conditional
- Follows **stable keys** requirement (key never appears/disappears)

No deviations, simplifications, or "safer alternatives" were found. The executor correctly identified this as a post-creation field, used the preferred `optional()` syntax for the default value, and exactly replicated the provider's `IntAtLeast(0)` validation.

**Status:** APPROVED ✅

---
