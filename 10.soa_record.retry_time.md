# Task #10 - soa_record.retry_time

## Summary
Implemented the `retry_time` argument within the `soa_record` block as part of the post-creation operation. The field is optional with a default of 300 and validation requiring a non-negative integer value.

## Shadow Implementation
```hcl
# In migrate_main.tf
locals {
  post_creation0 = var.soa_record != null ? {
    azapi_header = {
      type = "Microsoft.Network/privateDnsZones/SOA@2024-06-01"
    }
    body = {
      properties = {
        # ttl = ... # Task #11
        soaRecord = {
          email       = var.soa_record.email
          expireTime  = var.soa_record.expire_time
          minimumTtl  = var.soa_record.minimum_ttl
          refreshTime = var.soa_record.refresh_time
          retryTime   = var.soa_record.retry_time # <-
        }
        # metadata = ... # Task #12
      }
    }
    locks = local.locks
  } : null
}
```

```hcl
# In variables.tf
variable "soa_record" {
  type = object({
    email        = string
    expire_time  = optional(number, 2419200)
    minimum_ttl  = optional(number, 10)
    refresh_time = optional(number, 3600)
    retry_time   = optional(number, 300) # <-
    tags         = optional(map(string))
    ttl          = optional(number, 3600)
  })
  default     = null
  description = <<-EOT
   - `email` - (Required) The email contact for the SOA record.
   - `expire_time` - (Optional) The expire time for the SOA record. Defaults to `2419200`.
   - `minimum_ttl` - (Optional) The minimum Time To Live for the SOA record. By convention, it is used to determine the negative caching duration. Defaults to `10`.
   - `refresh_time` - (Optional) The refresh time for the SOA record. Defaults to `3600`.
   - `retry_time` - (Optional) The retry time for the SOA record. Defaults to `300`. # <-
   - `tags` - (Optional) A mapping of tags to assign to the Record Set.
   - `ttl` - (Optional) The Time To Live of the SOA Record in seconds. Defaults to `3600`.
EOT

  # ... other validations ...

  validation { # <-
    condition = var.soa_record == null || ( # <-
      var.soa_record.retry_time >= 0 # <-
    ) # <-
    error_message = "The `retry_time` must be at least 0." # <-
  } # <-
}
```

## Create Phase Verification

### Pattern: Post-Creation Operation
The `retry_time` field is part of the `soa_record` block, which is implemented as a post-creation operation (`post_creation0`) as documented in Task #5.

### Evidence from Create Method
From `resourcePrivateDnsZoneCreateUpdate`:

```go
// Phase 1: Primary zone creation
if err := client.CreateOrUpdateThenPoll(ctx, id, parameters, options); err != nil {
    return fmt.Errorf("creating/updating %s: %s", id, err)
}

// Phase 2: SOA record post-creation operation
if v, ok := d.GetOk("soa_record"); ok {
    soaRecordRaw := v.([]interface{})[0].(map[string]interface{})
    soaRecord := expandPrivateDNSZoneSOARecord(soaRecordRaw)  // <-- retry_time processed here
    rsParameters := privatedns.RecordSet{
        Properties: &privatedns.RecordSetProperties{
            Ttl:       pointer.To(int64(soaRecordRaw["ttl"].(int))),
            Metadata:  tags.Expand(soaRecordRaw["tags"].(map[string]interface{})),
            SoaRecord: soaRecord,  // <-- Contains RetryTime
        },
    }

    recordId := privatedns.NewRecordTypeID(id.SubscriptionId, id.ResourceGroupName, id.PrivateDnsZoneName, privatedns.RecordTypeSOA, "@")

    // ... validation ...

    if _, err := recordSetsClient.RecordSetsCreateOrUpdate(ctx, recordId, rsParameters, createOptions); err != nil {
        return fmt.Errorf("creating/updating %s: %s", recordId, err)
    }
}
```

### SDK Function Classification
- **Primary Operation**: `client.CreateOrUpdateThenPoll()` - Creates Private DNS Zone
- **Post-Operation**: `recordSetsClient.RecordSetsCreateOrUpdate()` - CreateOrUpdate function for SOA record
- **Classification**: Post-creation operation → `post_creation0` (index 0)

### Decision
The `retry_time` field is processed in the post-creation phase, not during primary zone creation. It's included in the `expandPrivateDNSZoneSOARecord` function and assigned to the SOA record via `RecordSetsCreateOrUpdate` API call.

## Assignment Path Verification

### Predicted Path
`body.properties.soaRecord.retryTime`

### Go Code Evidence
From `expandPrivateDNSZoneSOARecord`:
```go
func expandPrivateDNSZoneSOARecord(input map[string]interface{}) *privatedns.SoaRecord {
    return &privatedns.SoaRecord{
        Email:       pointer.To(input["email"].(string)),
        ExpireTime:  pointer.To(int64(input["expire_time"].(int))),
        MinimumTtl:  pointer.To(int64(input["minimum_ttl"].(int))),
        RefreshTime: pointer.To(int64(input["refresh_time"].(int))),
        RetryTime:   pointer.To(int64(input["retry_time"].(int))),  // <-- FIELD ASSIGNMENT
    }
}
```

From Create method:
```go
rsParameters := privatedns.RecordSet{
    Properties: &privatedns.RecordSetProperties{  // <-- .Properties assignment adds nesting
        Ttl:       pointer.To(int64(soaRecordRaw["ttl"].(int))),
        Metadata:  tags.Expand(soaRecordRaw["tags"].(map[string]interface{})),
        SoaRecord: soaRecord,  // <-- .SoaRecord nested under Properties
    },
}
```

### Verified Path
1. `RecordSet` struct → `.Properties` → `RecordSetProperties`
2. Within `RecordSetProperties` → `.SoaRecord` → `SoaRecord`
3. Within `SoaRecord` → `.RetryTime` (int64 pointer)

**Azure API Path**: `body.properties.soaRecord.retryTime`

### Path Comparison
✅ **Match**: The predicted path and verified path are identical. The field assignment follows:
- `input["retry_time"]` → `SoaRecord.RetryTime` → `RecordSetProperties.SoaRecord` → `RecordSet.Properties` → API body at `properties.soaRecord.retryTime`

## Provider Schema

### Schema Definition
From the resource schema:
```go
"retry_time": {
    Type:         pluginsdk.TypeInt,
    Optional:     true,
    Default:      300,
    ValidateFunc: validation.IntAtLeast(0),
},
```

### Key Properties
- **Type**: Int
- **Optional**: true
- **Default**: 300
- **ValidateFunc**: `validation.IntAtLeast(0)` - must be non-negative integer

## Azure API Schema

### Resource Type
`Microsoft.Network/privateDnsZones/SOA@2024-06-01`

### Property Path
`body.properties.soaRecord.retryTime`

### Schema Type
From Azure API query result:
```
"soaRecord":ObjectWithOptionalAttrs(map[string]Type{
    "email":String, 
    "expireTime":Number, 
    "host":String, 
    "minimumTtl":Number, 
    "refreshTime":Number,
    "retryTime":Number,  // <-- Number type
    "serialNumber":Number
}, ...)
```

**Type**: Number (maps to int64 in Go SDK)

### Azure API Documentation
From Azure API for `retryTime`:
- "The retry time for this SOA record."
- Represents how long secondary name servers should wait before retrying a failed zone transfer

## Hidden Fields Check

### Analysis
From the expand function:
```go
func expandPrivateDNSZoneSOARecord(input map[string]interface{}) *privatedns.SoaRecord {
    return &privatedns.SoaRecord{
        Email:       pointer.To(input["email"].(string)),
        ExpireTime:  pointer.To(int64(input["expire_time"].(int))),
        MinimumTtl:  pointer.To(int64(input["minimum_ttl"].(int))),
        RefreshTime: pointer.To(int64(input["refresh_time"].(int))),
        RetryTime:   pointer.To(int64(input["retry_time"].(int))),
    }
}
```

### Hidden Fields Found
**None** - The field is mapped directly from schema input to API field with type conversion only:
- Schema: `int` → Go: `int64` via type cast → API: `Number`
- No hidden fields added
- No additional logic or transformations

## Mapping (snake_case → camelCase)

| Schema Field | API Field | Notes |
|--------------|-----------|-------|
| `retry_time` | `retryTime` | Type conversion: int → int64 |

## Special Handling

### 1. Default Value
The field has a default value of 300 seconds (5 minutes).

**Implementation**: Using Terraform's `optional()` type constructor:
```hcl
retry_time = optional(number, 300)
```

This approach:
- ✅ Applies default when field is not specified
- ✅ Avoids need for conditional logic in locals
- ✅ Matches provider behavior exactly

### 2. Validation
The provider schema includes `validation.IntAtLeast(0)`.

**Implementation in variables.tf**:
```hcl
validation {
  condition = var.soa_record == null || (
    var.soa_record.retry_time >= 0
  )
  error_message = "The `retry_time` must be at least 0."
}
```

**Rationale**:
- ✅ Replicates provider's `IntAtLeast(0)` validation exactly
- ✅ Validates at plan time, not during API call
- ✅ Null-safe: only validates when `soa_record` block is set
- ✅ Clear error message matching provider behavior

### 3. Type Conversion
Provider converts from Terraform `int` to Go `int64`:
```go
RetryTime: pointer.To(int64(input["retry_time"].(int)))
```

**Implementation**: Direct assignment - Terraform handles numeric type compatibility:
```hcl
retryTime = var.soa_record.retry_time
```

**Why this works**:
- ✅ AzAPI provider 2.0+ accepts native Terraform types
- ✅ Terraform's `number` type is compatible with Azure API's `Number` schema
- ✅ No explicit type conversion needed in HCL

### 4. Parent Block Context
The field is only processed when parent `soa_record` block is not null:
- When `var.soa_record == null`: Entire `post_creation0` is null, no SOA record operation
- When `var.soa_record != null`: Full structure created, `retry_time` assigned with default if not specified

## Deferred Work Completion

### Check for Deferred Work
Checked `following.md` for any work deferred to Task #10.

**Result**: File does not exist - no deferred work to complete.

## Edge Case Analysis

### Null Semantics
- **`var.soa_record == null`**: Field not applicable, no SOA record customization
- **`var.soa_record.retry_time` not set**: Default of 300 applied via `optional(number, 300)`
- **`var.soa_record.retry_time` explicitly set**: User-provided value used

### Boundary Conditions
- **Minimum value**: 0 (validated)
- **Maximum value**: Terraform `number` type supports large integers (Go int64 range: -9223372036854775808 to 9223372036854775807)
- **Default value**: 300 seconds (5 minutes) - standard DNS retry interval
- **Typical range**: DNS retry times typically range from 60 (1 min) to 7200 (2 hours)

### Type Safety
- ✅ Terraform enforces `number` type
- ✅ Validation ensures non-negative
- ✅ Default value is within valid range
- ✅ Azure API accepts Number type (int64)

### Idempotency
- ✅ Same input produces same output
- ✅ Default value is stable across applies
- ✅ No order-dependent logic
- ✅ Direct value assignment (no transformations)

### Safe References
- ✅ `var.soa_record.retry_time` accessed only when `var.soa_record != null` (outer conditional in `post_creation0`)
- ✅ Type-safe: field defined in object schema with default
- ✅ Validation is null-safe with `var.soa_record == null ||` guard

## Critical Review

### Exact Provider Behavior Replication
✅ **Default value**: Matches provider's `Default: 300`
✅ **Validation**: Replicates `validation.IntAtLeast(0)` exactly
✅ **Type handling**: Matches provider's int to int64 conversion pattern
✅ **Post-creation context**: Correctly placed in `post_creation0.body.properties.soaRecord`
✅ **Null safety**: Parent block conditional ensures safe access

### No Simplified/Conservative Approaches
- ❌ Did NOT simplify validation (kept exact IntAtLeast(0) logic)
- ❌ Did NOT change default value for "safety"
- ❌ Did NOT add extra validations not in provider
- ❌ Did NOT use different placement in structure

### Completeness
- ✅ Field added to correct location in skeleton
- ✅ Default value applied via `optional()` syntax
- ✅ Validation added to `variables.tf`
- ✅ No hidden fields to add
- ✅ No cross-field validations involving this field
- ✅ No ForceNew tracking needed (parent block is ForceNew)

### Provider Behavior Match
From provider code:
```go
"retry_time": {
    Type:         pluginsdk.TypeInt,
    Optional:     true,
    Default:      300,
    ValidateFunc: validation.IntAtLeast(0),
}
```

Implementation matches:
- ✅ Optional field with default
- ✅ IntAtLeast(0) validation replicated
- ✅ Type: number (compatible with int)
- ✅ Processed in expand function exactly as provider does

## Checklist

- ✅ Property in correct local (`post_creation0.body.properties.soaRecord.retryTime`)
- ✅ ForceNew handled by parent block (Task #5)
- ✅ All logic exactly replicated from provider (default, validation, type conversion)
- ✅ Validation implemented in variables.tf (IntAtLeast(0))
- ✅ No TODO comments needed (field implementation complete, not migration to independent var)
- ✅ Hidden fields checked - none found
- ✅ No work deferred to other tasks
- ✅ No deferred work from following.md to complete
- ✅ Critical review completed - null safety, idempotency, type safety verified
- ✅ Edge Case Analysis included
- ✅ Proof document created
- ✅ Ready to update track.md to "Pending for check"
- ✅ Self-Review: Only `retry_time` field implemented, replaced comment placeholder, no other fields touched

## Implementation Verification

### Files Modified
1. **migrate_main.tf**: Replaced `# retryTime = ... # Task #10` with `retryTime = var.soa_record.retry_time`
2. **variables.tf**: Added validation block for `retry_time >= 0`

### Code Changes
**Before** (migrate_main.tf):
```hcl
soaRecord = {
  email       = var.soa_record.email
  expireTime  = var.soa_record.expire_time
  minimumTtl  = var.soa_record.minimum_ttl
  refreshTime = var.soa_record.refresh_time
  # retryTime = ... # Task #10
}
```

**After** (migrate_main.tf):
```hcl
soaRecord = {
  email       = var.soa_record.email
  expireTime  = var.soa_record.expire_time
  minimumTtl  = var.soa_record.minimum_ttl
  refreshTime = var.soa_record.refresh_time
  retryTime   = var.soa_record.retry_time
}
```

**Added** (variables.tf):
```hcl
validation {
  condition = var.soa_record == null || (
    var.soa_record.retry_time >= 0
  )
  error_message = "The `retry_time` must be at least 0."
}
```

### Exact Replication Confirmation
This implementation EXACTLY replicates the provider behavior:
1. ✅ Same default value (300)
2. ✅ Same validation (IntAtLeast 0)
3. ✅ Same type handling (number/int)
4. ✅ Same assignment path (properties.soaRecord.retryTime)
5. ✅ Same processing phase (post-creation)

No "more conservative" or "simpler" approaches were taken. The implementation is a precise replication of the provider's behavior.

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2025-12-23
**Task:** #10 - soa_record.retry_time

### Validation Results

✅ **ForceNew Logic:** Not applicable (parent block handles ForceNew)
✅ **Phase Detection:** Correctly placed in post_creation0 (post-creation operation)
✅ **Type Conversion:** Correct - Terraform number → Azure API Number
✅ **Null Handling:** Parent conditional ensures safe access; default via optional(number, 300)
✅ **Default Value Implementation:** PREFERRED method used - `optional(number, 300)` in object type (executor.md line 148)
✅ **Validations:** Provider validation `IntAtLeast(0)` correctly replicated in variables.tf validation block
✅ **Assignment Path:** Verified correct path: `post_creation0.body.properties.soaRecord.retryTime`
✅ **Deferred Work Completion:** No deferred work for this task (following.md does not exist)
✅ **Deferred Work Recording:** No deferrals made
✅ **Edge Cases:** Null semantics, boundary conditions, idempotency, and safe references all properly analyzed and handled
✅ **Scope Compliance:** Only retry_time field implemented, comment placeholder replaced, no scope creep
✅ **Root-Level Default:** Not applicable (nested field)
✅ **Shared Path Merge:** Not applicable (no merge conflicts in this implementation)

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. All validation checks passed:

1. **Default value**: Matches provider's `Default: 300` using PREFERRED `optional(number, 300)` syntax
2. **Validation**: Replicates `validation.IntAtLeast(0)` exactly in variables.tf validation block
3. **Type handling**: Correct Terraform number type compatible with Azure API Number
4. **Placement**: Correctly placed in `post_creation0.body.properties.soaRecord.retryTime`
5. **Null safety**: Parent block conditional ensures safe access
6. **No deviations**: No simplifications, no "safer alternatives", no deviations from exact provider logic

**Status:** APPROVED ✅

---
