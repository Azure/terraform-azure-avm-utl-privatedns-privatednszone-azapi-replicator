# Task #8 - soa_record.minimum_ttl

## Summary
Implemented the `minimum_ttl` field within the `soa_record` block as an optional number field with a default value of 10 and validation requiring a minimum value of 0. The field maps to `body.properties.soaRecord.minimumTtl` in the post-creation SOA record update operation.

## Shadow Implementation
```hcl
# In variables.tf
variable "soa_record" {
  type = object({
    minimum_ttl  = optional(number, 10) # <-
    # ... other fields ...
  })
  
  validation { # <-
    condition = var.soa_record == null || ( # <-
      var.soa_record.minimum_ttl >= 0 # <-
    )
    error_message = "The `minimum_ttl` must be at least 0." # <-
  }
}

# In migrate_main.tf
locals {
  post_creation0 = var.soa_record != null ? {
    body = {
      properties = {
        soaRecord = {
          minimumTtl = var.soa_record.minimum_ttl # <-
        }
      }
    }
  } : null
}
```

## Create Phase Verification

### Pattern: Post-Creation Operation
The `minimum_ttl` field is part of the SOA record, which is handled as a post-creation operation after the primary zone creation.

### Evidence from Create Method
From `resourcePrivateDnsZoneCreateUpdate`:

```go
// Phase 1: Primary zone creation
if err := client.CreateOrUpdateThenPoll(ctx, id, parameters, options); err != nil {
    return fmt.Errorf("creating/updating %s: %s", id, err)
}

// Phase 2: SOA record post-creation operation
if v, ok := d.GetOk("soa_record"); ok {
    soaRecordRaw := v.([]interface{})[0].(map[string]interface{})
    soaRecord := expandPrivateDNSZoneSOARecord(soaRecordRaw)  // <-- minimum_ttl field expanded here
    rsParameters := privatedns.RecordSet{
        Properties: &privatedns.RecordSetProperties{
            Ttl:       pointer.To(int64(soaRecordRaw["ttl"].(int))),
            Metadata:  tags.Expand(soaRecordRaw["tags"].(map[string]interface{})),
            SoaRecord: soaRecord,  // <-- soaRecord struct contains minimumTtl
        },
    }

    recordId := privatedns.NewRecordTypeID(id.SubscriptionId, id.ResourceGroupName, id.PrivateDnsZoneName, privatedns.RecordTypeSOA, "@")

    if _, err := recordSetsClient.RecordSetsCreateOrUpdate(ctx, recordId, rsParameters, createOptions); err != nil {
        return fmt.Errorf("creating/updating %s: %s", recordId, err)
    }
}
```

### SDK Function Classification
- **Operation**: `recordSetsClient.RecordSetsCreateOrUpdate()` - CreateOrUpdate function
- **Classification**: Post-creation operation → `post_creation0`
- **Resource Type**: `Microsoft.Network/privateDnsZones/SOA@2024-06-01`

### Decision
The `minimum_ttl` field is implemented in `local.post_creation0.body.properties.soaRecord.minimumTtl` because it's processed in the post-creation SOA record update operation, not during the primary zone creation.

## Assignment Path Verification

### Predicted Path
`body.properties.soaRecord.minimumTtl`

### Go Code Evidence

From `expandPrivateDNSZoneSOARecord`:
```go
func expandPrivateDNSZoneSOARecord(input map[string]interface{}) *privatedns.SoaRecord {
    return &privatedns.SoaRecord{
        Email:       pointer.To(input["email"].(string)),
        ExpireTime:  pointer.To(int64(input["expire_time"].(int))),
        MinimumTtl:  pointer.To(int64(input["minimum_ttl"].(int))),  // <-- minimum_ttl extracted from input
        RefreshTime: pointer.To(int64(input["refresh_time"].(int))),
        RetryTime:   pointer.To(int64(input["retry_time"].(int))),
    }
}
```

From Create method:
```go
rsParameters := privatedns.RecordSet{
    Properties: &privatedns.RecordSetProperties{  // <-- Properties assignment
        SoaRecord: soaRecord,  // <-- soaRecord nested under Properties
    },
}
```

### Assignment Trace
1. `input["minimum_ttl"]` → `SoaRecord.MinimumTtl`
2. `SoaRecord` → `RecordSetProperties.SoaRecord`
3. `RecordSetProperties` → `RecordSet.Properties`
4. Final Azure API path: `body.properties.soaRecord.minimumTtl`

### Verified Path
✅ **Match**: The predicted path `body.properties.soaRecord.minimumTtl` matches the verified assignment trace through the Go code.

## Provider Schema

### Schema Definition
From the resource schema:
```go
"minimum_ttl": {
    Type:         pluginsdk.TypeInt,
    Optional:     true,
    Default:      10,
    ValidateFunc: validation.IntAtLeast(0),
},
```

### Key Properties
- **Type**: Int
- **Optional**: true
- **Default**: 10
- **Computed**: false
- **ForceNew**: Inherited from parent block (`soa_record` has `ForceNew: true`)
- **ValidateFunc**: `validation.IntAtLeast(0)` - must be at least 0

## Azure API Schema

### Property Path
`body.properties.soaRecord.minimumTtl`

### Azure API Type
From query result:
```
Number
```

### Azure API Documentation
"The minimum value for this SOA record. By convention this is used to determine the negative caching duration."

The minimum TTL is conventionally used to determine how long negative responses (NXDOMAIN) can be cached by DNS resolvers.

## Hidden Fields Check

### Analysis
No hidden fields. The `minimum_ttl` field directly maps from schema to API with no additional transformations or hidden values.

## Mapping (snake_case → camelCase)

| Schema Field | API Field | Notes |
|--------------|-----------|-------|
| `minimum_ttl` | `minimumTtl` | Standard camelCase conversion |

## Special Handling

### 1. Default Value Implementation
The provider schema specifies `Default: 10`.

**Implementation in `variables.tf`:**
The default is implemented using Terraform's `optional()` type constructor:

```hcl
minimum_ttl = optional(number, 10)
```

This exactly replicates the provider's default behavior:
- When `minimum_ttl` is not provided in the `soa_record` block, it defaults to `10`
- When explicitly set, the provided value is used
- The default is applied at the variable level, matching where the provider applies it

### 2. Validation Implementation
The provider uses `validation.IntAtLeast(0)`, which ensures the value is at least 0.

**Implementation in `variables.tf`:**
```hcl
validation {
  condition = var.soa_record == null || (
    var.soa_record.minimum_ttl >= 0
  )
  error_message = "The `minimum_ttl` must be at least 0."
}
```

**Rationale**:
- Guard condition `var.soa_record == null` allows the entire block to be absent
- Direct comparison `>= 0` exactly replicates the `IntAtLeast(0)` validation
- Error message clearly describes the constraint

### 3. ForceNew Behavior
The `minimum_ttl` field inherits ForceNew behavior from the parent `soa_record` block (which has `ForceNew: true`). This is already handled at the block level in Task #5's `replace_triggers_external_values`.

No additional ForceNew tracking is needed for individual fields within the block.

### 4. Type Conversion
The provider schema defines the field as `TypeInt`, and the expand function converts it to `int64`:

```go
MinimumTtl: pointer.To(int64(input["minimum_ttl"].(int)))
```

In Terraform, the variable is defined as `number` type. Terraform will handle the conversion automatically when passing to the AzAPI provider, which expects numeric values in JSON format. No explicit conversion is needed in our implementation.

## Deferred Work Completion

### No Deferred Work
Checked `following.md` - file does not exist. No work was deferred to this task.

### Work Deferred FROM This Task
None. All logic for the `minimum_ttl` field has been implemented in this task, including default value and validation.

## Edge Case Analysis

### Null Semantics
- **`var.soa_record == null`**: minimum_ttl field is not evaluated; post-creation operation is skipped
- **`var.soa_record != null && minimum_ttl not specified`**: Defaults to `10` (via `optional()` type constructor)
- **`var.soa_record.minimum_ttl == 0`**: Valid - minimum allowed value

### Boundary Conditions
- **Minimum value**: `0` (allowed, validated) ✅
- **Default value**: `10` ✅
- **Maximum value**: No explicit maximum in provider validation; limited by int64 range in Go
- **Negative values**: Invalid - caught by validation (`>= 0`) ✅

### Common Values
- **0**: Minimum allowed, would effectively disable negative caching
- **10**: Default value, very short negative caching duration (10 seconds)
- **60**: One minute, reasonable for frequently changing zones
- **300**: Five minutes, common for stable zones
- **3600**: One hour, longer negative caching for very stable zones

### Idempotency
- ✅ minimum_ttl value directly assigned from variable
- ✅ No order-dependent operations
- ✅ No transformations that could produce different results on re-apply
- ✅ Default value applied consistently via `optional()` type constructor

### Safe References
- ✅ `var.soa_record.minimum_ttl` only accessed when `var.soa_record != null` (checked in parent conditional)
- ✅ Validation condition checks `var.soa_record == null` first
- ✅ No nested field access without null guards

## Critical Review

### Exact Provider Behavior Replication
✅ **Default value**: Exactly matches provider's `Default: 10` via `optional(number, 10)`
✅ **Validation**: Exactly replicates `validation.IntAtLeast(0)` with `>= 0` condition
✅ **Assignment path**: Correct path `body.properties.soaRecord.minimumTtl` in post-creation operation
✅ **Type handling**: Number type correctly maps to Go's int64 conversion

### Validation Comparison
| Provider Rule | Terraform Implementation | Match |
|---------------|--------------------------|-------|
| `IntAtLeast(0)` | `var.soa_record.minimum_ttl >= 0` | ✅ |
| Default: 10 | `optional(number, 10)` | ✅ |

### No Simplified/Conservative Approaches
- ❌ Did NOT skip validation
- ❌ Did NOT use a different default value
- ❌ Did NOT defer validation to Azure API
- ✅ Implemented exact default and validation from provider

### Completeness
- ✅ Field added to correct location in `post_creation0.body.properties.soaRecord`
- ✅ Default value implemented via `optional()` type constructor
- ✅ Validation implemented in `variables.tf`
- ✅ No hidden fields to handle
- ✅ No sensitive field handling needed
- ✅ ForceNew handled by parent block

## Checklist

- ✅ Property in correct local (`post_creation0.body.properties.soaRecord.minimumTtl`)
- ✅ ForceNew handled by parent block (no individual field wrapping needed)
- ✅ All logic exactly replicated from provider (default value + validation)
- ✅ Validations IMPLEMENTED in variables.tf (MANDATORY - IntAtLeast(0))
- ✅ No TODO comment needed (not sensitive field migration)
- ✅ Hidden fields checked - none found
- ✅ No deferred work in following.md (file doesn't exist)
- ✅ No deferred work from following.md (file doesn't exist)
- ✅ Critical review completed - null safety, edge cases, exact validation replication verified
- ✅ Edge Case Analysis included
- ✅ Proof document created
- ✅ Ready to update track.md to "Pending for check"
- ✅ Self-Review: Only minimum_ttl field implementation added, no other fields, no content from other tasks

## Test Cases

### Valid Inputs
```hcl
# Using default value
soa_record = { email = "admin.contoso.com" }
# minimum_ttl defaults to 10

# Explicit default
soa_record = { 
  email = "admin.contoso.com"
  minimum_ttl = 10 
}

# Minimum value
soa_record = { 
  email = "admin.contoso.com"
  minimum_ttl = 0 
}

# Common values
soa_record = { 
  email = "admin.contoso.com"
  minimum_ttl = 60  # 1 minute
}

soa_record = { 
  email = "admin.contoso.com"
  minimum_ttl = 300  # 5 minutes
}

soa_record = { 
  email = "admin.contoso.com"
  minimum_ttl = 3600  # 1 hour
}
```

### Invalid Inputs (Should Fail Validation)
```hcl
# Negative value
soa_record = { 
  email = "admin.contoso.com"
  minimum_ttl = -1  # Fails: must be at least 0
}

soa_record = { 
  email = "admin.contoso.com"
  minimum_ttl = -60  # Fails: must be at least 0
}
```

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2025-12-23
**Task:** #8 - soa_record.minimum_ttl

### Validation Results

✅ **Default Value Implementation:** EXACT match - uses preferred `optional(number, 10)` syntax in object type (executor.md line 148)
✅ **Validation Implementation:** EXACT replication - `IntAtLeast(0)` correctly implemented as `>= 0` condition in variables.tf
✅ **Phase Detection:** Correctly placed in `post_creation0` - field processed in SOA record post-creation operation after primary zone creation
✅ **Assignment Path:** Correct path `body.properties.soaRecord.minimumTtl` verified through Go code trace
✅ **Type Conversion:** Correct conversion from `number` (Terraform) to numeric JSON value for Azure API
✅ **Null Handling:** Correctly guarded - field only accessed when `var.soa_record != null`
✅ **ForceNew Logic:** Correctly handled at parent block level (Task #5) - no individual field wrapping needed
✅ **Stable Keys:** N/A - no replace_triggers_external_values entry needed for this field
✅ **Validations:** All provider validations (`IntAtLeast(0)`) implemented in variables.tf as required
✅ **Deferred Work Completion:** No deferred work for this task (following.md does not exist)
✅ **Edge Cases:** Comprehensive analysis completed - null semantics, boundary conditions (0, negative values), default value behavior all verified

### Method Priority Compliance

**Default Value Method:**
- executor.md specifies: "Nested (PREFER): `optional(bool, true)` or `optional(string, "PT1H30M")` in object type"
- Implementation uses: `optional(number, 10)`
- **Verdict:** ✅ EXACT compliance with PREFERRED method

**Validation Method:**
- Provider schema: `ValidateFunc: validation.IntAtLeast(0)`
- Implementation: `var.soa_record.minimum_ttl >= 0` in validation block
- **Verdict:** ✅ EXACT replication of provider validation logic

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. No deviations, simplifications, or "safer alternatives" were found.

**Specific Compliance Points:**
- Default value of 10 exactly matches provider's `Default: 10`
- Validation `>= 0` exactly matches provider's `validation.IntAtLeast(0)`
- Field placed in correct phase (`post_creation0`) based on Go code evidence
- Assignment path correctly traced through Go struct assignments
- No forbidden implementation patterns detected
- No unauthorized deviations from executor.md rules

**Status:** APPROVED ✅

---
