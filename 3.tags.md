# Task #3 - `tags` Argument Migration

## Summary
The root-level `tags` argument was already migrated in Task #1 as part of the complete `azapi_header` initialization. This task documents and verifies the implementation.

## Shadow Implementation

```hcl
# migrate_main.tf (already implemented in Task #1)
locals {
  azapi_header = {
    # ...
    tags = var.tags  # <-
    # ...
  }
}
```

```hcl
# variables.tf (already exists in root module)
variable "tags" {  # <-
  type        = map(string)  # <-
  description = "(Optional) A mapping of tags to assign to the resource."  # <-
  default     = null  # <-
}  # <-
```

## Create Phase Verification

### Query Create Method
Queried the Create method using `query_terraform_block_implementation_source_code(block_type="resource", terraform_type="azurerm_private_dns_zone", entrypoint_name="create")`.

### Pattern Identification
The Create method follows a **single-phase pattern**:

```go
func resourcePrivateDnsZoneCreateUpdate(d *pluginsdk.ResourceData, meta interface{}) error {
	client := meta.(*clients.Client).PrivateDns.PrivateZonesClient
	// ...
	parameters := privatezones.PrivateZone{
		Location: pointer.To("global"),
		Tags:     tags.Expand(d.Get("tags").(map[string]interface{})),
	}
	
	options := privatezones.CreateOrUpdateOperationOptions{
		IfMatch:     pointer.To(""),
		IfNoneMatch: pointer.To(""),
	}
	
	if err := client.CreateOrUpdateThenPoll(ctx, id, parameters, options); err != nil {
		return fmt.Errorf("creating/updating %s: %s", id, err)
	}
	// ...
}
```

### Field Classification
- **Phase**: Create phase (before the `CreateOrUpdateThenPoll` call)
- **Usage**: The `tags` field is retrieved via `d.Get("tags").(map[string]interface{})` and expanded using `tags.Expand()`
- **Assignment**: Assigned to `parameters.Tags` before the API call
- **Decision**: Add to `azapi_header.tags` (root-level parameter in AzAPI, not in body)

## Assignment Path Verification

### Predicted Path
`azapi_header.tags` (top-level parameter, not in body)

### Go Code Evidence
```go
parameters := privatezones.PrivateZone{
	Location: pointer.To("global"),
	Tags:     tags.Expand(d.Get("tags").(map[string]interface{})),
}

if err := client.CreateOrUpdateThenPoll(ctx, id, parameters, options); err != nil {
```

The `tags` field is assigned directly to the `PrivateZone` struct at the root level (not nested in Properties). According to the Azure REST API structure:
- Root-level fields in the API: `location`, `tags`, `properties`
- In AzAPI provider: `tags` is a top-level `azapi_resource` parameter (not in body)

### Verified Path
`azapi_header.tags`

### Path Comparison
✅ **Match** - The `tags` is a root-level resource property that maps to the top-level `tags` parameter in `azapi_resource`.

## Provider Schema

From the schema query result:

```go
"tags": commonschema.Tags(),
```

The `commonschema.Tags()` function returns:

```go
&pluginsdk.Schema{
	Type:     pluginsdk.TypeMap,
	Optional: true,
	Elem: &pluginsdk.Schema{
		Type: pluginsdk.TypeString,
	},
}
```

**Key Properties:**
- **Type**: Map of strings
- **Optional**: true (can be null)
- **ForceNew**: false (can be updated)
- **Validation**: None (no ValidateFunc specified)
- **DiffSuppressFunc**: None

## Azure API Schema

The Azure API documentation shows `tags` is a root-level property:

```json
{
  "tags": "Map(String)"
}
```

Description: "A mapping of tags which should be assigned to the Azure resource."

The `tags` is at the root level of the API request body, NOT inside `properties`.

## Hidden Fields

**No hidden fields detected** for the `tags` argument.

## Mapping

| AzureRM Field | AzAPI Field | Notes |
|---------------|-------------|-------|
| `tags` | `azapi_header.tags` | Direct mapping, top-level parameter |

## Special Handling

### ForceNew
The `tags` field does NOT have `ForceNew: true` in the provider schema, which means tags can be updated in-place without forcing resource recreation.

**Implementation:**
Since `tags` is NOT ForceNew, it should NOT be added to `replace_triggers_external_values`.

✅ **Verified**: No entry in `replace_triggers_external_values` for `tags` - correct behavior.

### Validation
No validation is specified in the provider schema for the `tags` field. Azure accepts any map of strings as tags.

**Decision:** No validation block needed in `variables.tf` since the provider schema doesn't specify validation.

### Update Support
The Update method is the same as the Create method (`resourcePrivateDnsZoneCreateUpdate`), which means tags can be updated after resource creation.

```go
func resourcePrivateDnsZone() *pluginsdk.Resource {
	return &pluginsdk.Resource{
		Create:   resourcePrivateDnsZoneCreateUpdate,
		Read:     resourcePrivateDnsZoneRead,
		Update:   resourcePrivateDnsZoneCreateUpdate,  // Same as Create
		Delete:   resourcePrivateDnsZoneDelete,
		// ...
	}
}
```

✅ **Verified**: Tags are updateable, no `post_creation_updates` needed.

### Null Handling
The provider uses `tags.Expand()` which handles null values:
- If `var.tags` is `null`, it becomes `nil` in Go
- Azure API treats `nil` tags as "no tags" (empty map)
- This is idempotent behavior

## Critical Review & Edge Case Analysis

### Null Semantics
- **Input**: `var.tags` has `default = null` (Optional field)
- **Behavior**: When null, no tags are applied to the resource
- **Meaning**: "No tags" vs "Keep existing tags" - In Create, null means no tags; In Update, the provider sends the current state, so null means "remove all tags"

### Boundary Conditions
- **Empty map**: `{}` is valid - resource has no tags
- **Null**: `null` is valid - resource has no tags (same result as empty map)
- **Large maps**: No limit specified in provider, Azure API has reasonable limits
- **Special characters in keys/values**: Azure tag naming conventions apply, validated by Azure API

### Idempotency
- **Stable**: Tag map is passed directly without transformation
- **Order independence**: Maps are unordered in Terraform, order doesn't matter
- **Null handling**: Consistent behavior (null = no tags)

### Safe References
- **Direct reference**: `var.tags` can be null, but that's handled correctly
- **No nested access**: Top-level variable, used as-is in azapi_header
- **Type safety**: Terraform enforces `map(string)` type at plan time

### Edge Cases
1. **Null vs Empty Map**: Both result in no tags on the resource (equivalent)
2. **Tag updates**: Changing tags only updates the tags, doesn't recreate resource (correct - no ForceNew)
3. **Tag removal**: Setting `tags = null` or `tags = {}` removes all tags (expected behavior)
4. **Case sensitivity**: Tag keys are case-sensitive in Azure (no DiffSuppressFunc needed)

## Deferred Work Completion

**No deferred work** was assigned to this task in `following.md` (file doesn't exist yet).

## Deferred Work Recording

**No work deferred** to other tasks from this task.

## Checklist

- ✅ Property in correct local (`azapi_header.tags`)
- ✅ ForceNew: NOT ForceNew, correctly excluded from `replace_triggers_external_values`
- ✅ All logic exactly replicated from provider (direct assignment via var.tags)
- ✅ Validations: None required per provider schema (no ValidateFunc)
- ✅ Hidden fields checked (none for tags)
- ✅ Deferred work in following.md: N/A (no cross-field dependencies)
- ✅ Deferred work from following.md: N/A (file doesn't exist)
- ✅ Critical review completed (null, edge, idempotent, safe refs)
- ✅ Edge Case Analysis in proof
- ✅ Proof created
- ✅ `track.md` will be updated to Pending for check
- ✅ Self-Review: Only verified tags field (Task #3 scope); implementation was already completed in Task #1 as part of azapi_header initialization

## Implementation Note

According to `executor.md` Task #1 special instructions:
> **Special - name (Task #1):** Create complete `azapi_header` with `type`, `name`, `location`, `parent_id`, `tags`, `ignore_null_property`, and `retry`.

The `tags` field was correctly included in the `azapi_header` during Task #1 as required. This task (Task #3) serves to document and verify that the implementation is complete and correct.

The implementation exactly matches the provider behavior:
1. ✅ Uses `var.tags` directly (no transformation)
2. ✅ Placed at top-level in `azapi_header` (not in body)
3. ✅ No ForceNew tracking (updateable field)
4. ✅ No validation (provider has no validation)
5. ✅ Null handling is correct (null = no tags)

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2025-12-22
**Task:** #3 - tags

### Validation Results

✅ **ForceNew Logic:** Not ForceNew - correctly excluded from `replace_triggers_external_values`
✅ **Stable Keys:** N/A (not in replace_triggers_external_values)
✅ **Phase Detection:** Field correctly placed in `azapi_header.tags` (top-level parameter, implemented in Task #1)
✅ **Type Conversion:** Direct mapping from `map(string)` to `map(string)` - no conversion needed
✅ **Null Handling:** Correctly propagates null semantics (null = no tags, empty map = no tags)
✅ **Validations:** None required - provider schema has no ValidateFunc
✅ **Default Value Handling:** No Default in provider schema - correctly implemented with `default = null` and no `nullable = false` requirement
✅ **Deferred Work Completion:** No deferred work for this task
✅ **Deferred Work Recording:** No deferrals made
✅ **Edge Cases:** All edge cases properly analyzed and handled (null vs empty map, tag updates, tag removal, case sensitivity)

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. The `tags` field:
- Was correctly implemented in Task #1 as part of the complete `azapi_header` initialization per executor.md Task #1 special instructions
- Is placed at the top-level `azapi_header.tags` parameter (not in body), matching Azure REST API structure
- Uses `var.tags` directly without transformation, matching provider's `tags.Expand()` behavior
- Is correctly excluded from ForceNew tracking (updateable field)
- Has no validation requirements (matches provider schema)
- Handles null semantics correctly (null = no tags)

No deviations, simplifications, or "safer alternatives" were found.

**Status:** APPROVED ✅

---
