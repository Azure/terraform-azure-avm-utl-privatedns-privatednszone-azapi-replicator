# Task #11 - soa_record.ttl - Implementation Proof

## Summary
Implemented the `soa_record.ttl` field as an optional argument with default value 3600 and validation for range [0, 2147483647]. The field is assigned in the post_creation0 phase at `properties.ttl` path in the SOA record.

## Shadow Implementation

```hcl
# migrate_main.tf
locals {
  post_creation0 = var.soa_record != null ? {
    azapi_header = {
      type = "Microsoft.Network/privateDnsZones/SOA@2024-06-01"
    }
    body = {
      properties = {
        ttl = var.soa_record.ttl # <-
        soaRecord = {
          email       = var.soa_record.email
          expireTime  = var.soa_record.expire_time
          minimumTtl  = var.soa_record.minimum_ttl
          refreshTime = var.soa_record.refresh_time
          retryTime   = var.soa_record.retry_time
        }
        # metadata = ... # Task #12
      }
    }
    locks = local.locks
  } : null
}
```

```hcl
# variables.tf
variable "soa_record" {
  type = object({
    email        = string
    expire_time  = optional(number, 2419200)
    minimum_ttl  = optional(number, 10)
    refresh_time = optional(number, 3600)
    retry_time   = optional(number, 300)
    tags         = optional(map(string))
    ttl          = optional(number, 3600)
  })
  default     = null
  description = <<-EOT
 - `email` - (Required) The email contact for the SOA record.
 - `expire_time` - (Optional) The expire time for the SOA record. Defaults to `2419200`.
 - `minimum_ttl` - (Optional) The minimum Time To Live for the SOA record. By convention, it is used to determine the negative caching duration. Defaults to `10`.
 - `refresh_time` - (Optional) The refresh time for the SOA record. Defaults to `3600`.
 - `retry_time` - (Optional) The retry time for the SOA record. Defaults to `300`.
 - `tags` - (Optional) A mapping of tags to assign to the Record Set.
 - `ttl` - (Optional) The Time To Live of the SOA Record in seconds. Defaults to `3600`.
EOT

  # ... existing validations ...

  validation { # <-
    condition = var.soa_record == null || ( # <-
      var.soa_record.ttl >= 0 && var.soa_record.ttl <= 2147483647 # <-
    ) # <-
    error_message = "The `ttl` must be between 0 and 2147483647." # <-
  } # <-
}
```

## Create Phase Verification

### Query Results
Querying the Create method shows the following pattern:

```go
func resourcePrivateDnsZoneCreateUpdate(d *pluginsdk.ResourceData, meta interface{}) error {
	client := meta.(*clients.Client).PrivateDns.PrivateZonesClient
	recordSetsClient := meta.(*clients.Client).PrivateDns.RecordSetsClient
	// ...
	
	// PRIMARY CREATE - Create the Private DNS Zone
	if err := client.CreateOrUpdateThenPoll(ctx, id, parameters, options); err != nil {
		return fmt.Errorf("creating/updating %s: %s", id, err)
	}

	// POST-CREATION OPERATION - Create SOA Record
	if v, ok := d.GetOk("soa_record"); ok {
		soaRecordRaw := v.([]interface{})[0].(map[string]interface{})
		soaRecord := expandPrivateDNSZoneSOARecord(soaRecordRaw)
		rsParameters := privatedns.RecordSet{
			Properties: &privatedns.RecordSetProperties{
				Ttl:       pointer.To(int64(soaRecordRaw["ttl"].(int))), // <-- TTL assigned here
				Metadata:  tags.Expand(soaRecordRaw["tags"].(map[string]interface{})),
				SoaRecord: soaRecord,
			},
		}

		recordId := privatedns.NewRecordTypeID(id.SubscriptionId, id.ResourceGroupName, id.PrivateDnsZoneName, privatedns.RecordTypeSOA, "@")

		// ...

		if _, err := recordSetsClient.RecordSetsCreateOrUpdate(ctx, recordId, rsParameters, createOptions); err != nil {
			return fmt.Errorf("creating/updating %s: %s", recordId, err)
		}
	}
	// ...
}
```

### Pattern Classification
**Pattern**: Two-phase creation
1. **Primary Create**: `client.CreateOrUpdateThenPoll()` creates the Private DNS Zone
2. **Post-Creation Operation**: `recordSetsClient.RecordSetsCreateOrUpdate()` creates the SOA record

**SDK Function**: `RecordSetsCreateOrUpdate` (CreateOrUpdate pattern)

**Classification**: This is a **post_creation0** operation (first CreateOrUpdate after primary create)

### Field Assignment Phase
The `ttl` field is assigned in the **POST-CREATION phase** (after the primary Private DNS Zone creation), specifically in the SOA record creation via `recordSetsClient.RecordSetsCreateOrUpdate()`.

**Decision**: Implement in `local.post_creation0.body.properties.ttl`

## Assignment Path Verification

### Predicted Path
Based on Azure API schema for `Microsoft.Network/privateDnsZones/SOA@2024-06-01`, the predicted path is:
- `properties.ttl`

### Go Code Evidence
From the Create method:

```go
rsParameters := privatedns.RecordSet{
	Properties: &privatedns.RecordSetProperties{
		Ttl:       pointer.To(int64(soaRecordRaw["ttl"].(int))),
		Metadata:  tags.Expand(soaRecordRaw["tags"].(map[string]interface{})),
		SoaRecord: soaRecord,
	},
}
```

### Assignment Trace
1. `soaRecordRaw["ttl"].(int)` - Extract ttl from the map
2. `int64(...)` - Convert to int64
3. `pointer.To(...)` - Convert to pointer
4. Assign to `RecordSet.Properties.Ttl`

### Verified Path
The Go code confirms:
- `RecordSet` struct → `Properties` field → `RecordSetProperties.Ttl` field
- In JSON: `properties.ttl`

### Path Comparison
✅ **MATCH**: Predicted path `properties.ttl` matches verified path from Go code.

## Provider Schema

From `resourcePrivateDnsZone()` schema definition:

```go
"soa_record": {
	Type:     pluginsdk.TypeList,
	MaxItems: 1,
	Optional: true,
	Computed: true,
	ForceNew: true,
	Elem: &pluginsdk.Resource{
		Schema: map[string]*pluginsdk.Schema{
			// ...
			"ttl": {
				Type:         pluginsdk.TypeInt,
				Optional:     true,
				Default:      3600,
				ValidateFunc: validation.IntBetween(0, math.MaxInt32),
			},
			// ...
		},
	},
},
```

**Key Properties:**
- **Type**: Int
- **Optional**: true
- **Default**: 3600
- **ValidateFunc**: `validation.IntBetween(0, math.MaxInt32)` where `math.MaxInt32 = 2147483647`
- **ForceNew**: true (inherited from parent `soa_record` block)

## Azure API Schema

From Azure API schema for `Microsoft.Network/privateDnsZones/SOA@2024-06-01`:

```
"ttl": Number
```

At path: `properties.ttl`

Description: "The TTL (time-to-live) of the records in the record set."

## Hidden Fields

No hidden fields associated with the `ttl` field.

## Naming Mapping

- **Terraform (snake_case)**: `ttl`
- **Azure API (camelCase)**: `ttl`

✅ No transformation needed - both use lowercase `ttl`.

## Special Handling

### Default Value
The field has a default value of 3600, which is implemented using the `optional(number, 3600)` syntax in the variable type definition:

```hcl
variable "soa_record" {
  type = object({
    # ...
    ttl = optional(number, 3600)
  })
}
```

### Validation
Implemented validation in `variables.tf` to replicate the provider's `IntBetween(0, math.MaxInt32)` validation:

```hcl
validation {
  condition = var.soa_record == null || (
    var.soa_record.ttl >= 0 && var.soa_record.ttl <= 2147483647
  )
  error_message = "The `ttl` must be between 0 and 2147483647."
}
```

**Note**: `math.MaxInt32` in Go equals `2147483647` (2^31 - 1).

### ForceNew Behavior
The entire `soa_record` block has `ForceNew: true` set in the provider schema, which means any change to the `soa_record` block (including the `ttl` field) will trigger resource replacement. This is already handled in Task #5 where the parent block skeleton was created with:

```hcl
replace_triggers_external_values = {
  soa_record = { value = var.soa_record != null ? true : null }
}
```

### Post-Creation Assignment
The `ttl` field is assigned in the `post_creation0` phase at `properties.ttl`, as documented in the Create Phase Verification section.

## Deferred Work Completion

Checked `following.md` - file does not exist, so no deferred work to complete for this task.

## Critical Review & Edge Case Analysis

### Null Semantics
- **When `var.soa_record` is `null`**: The entire `soa_record` block is not created, so `ttl` is not set.
- **When `var.soa_record.ttl` is not explicitly set**: The default value of 3600 is used (handled by `optional(number, 3600)` in the type definition).
- **When `var.soa_record.ttl` is explicitly set to a value**: That value is used directly.

### Boundary Conditions
- **Minimum value (0)**: Valid - validation allows 0.
- **Maximum value (2147483647)**: Valid - validation allows up to `math.MaxInt32`.
- **Negative values**: Invalid - caught by validation.
- **Values > 2147483647**: Invalid - caught by validation.

### Idempotency
The field assignment is idempotent:
- Same input always produces same output
- No order-dependent operations
- No stateful transformations

### Safe References
The implementation safely references `var.soa_record.ttl`:
- The parent condition `var.soa_record != null` ensures the object exists before accessing the field
- The field is defined with a default value in the type definition, so it will never be null within the object

### Type Conversion
The Azure API expects a `Number` type (which maps to int64 in Go). The provider converts from Terraform's int to int64:
```go
Ttl: pointer.To(int64(soaRecordRaw["ttl"].(int)))
```

Our implementation passes the value directly as `var.soa_record.ttl`, which is a `number` type in Terraform. The AzAPI provider will handle the type conversion to the appropriate Azure API type.

## Checklist

- ✅ Property in correct local (`local.post_creation0.body.properties.ttl`)
- ✅ Default value implemented using `optional(number, 3600)` in type definition
- ✅ Validation IMPLEMENTED in `variables.tf` (IntBetween 0 to 2147483647)
- ✅ All logic EXACTLY replicated from provider (no shortcuts)
- ✅ Hidden fields checked (none found)
- ✅ Deferred work checked (no following.md file exists)
- ✅ Critical review completed (null, edge, idempotent, safe refs)
- ✅ Edge Case Analysis in proof (see above)
- ✅ Proof created
- ✅ Implementation exactly matches provider behavior with Go code evidence
- ✅ Self-Review: Only implemented what Task #11 requires (soa_record.ttl field)

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2025-12-23
**Task:** #11 - soa_record.ttl

### Validation Results

✅ **Phase Detection:** Field correctly placed in `local.post_creation0.body.properties.ttl` (post-creation phase via RecordSetsCreateOrUpdate)
✅ **Type Conversion:** Correct conversion from Terraform `number` to Azure API `Number` type
✅ **Null Handling:** Correctly propagates null semantics (parent condition guards field access)
✅ **Default Value:** Correctly implemented using PREFERRED method `optional(number, 3600)` per executor.md lines 147-148
✅ **Validation:** Provider validation `IntBetween(0, math.MaxInt32)` correctly replicated in `variables.tf` with range [0, 2147483647]
✅ **ForceNew Logic:** Inherited from parent `soa_record` block (handled in Task #5)
✅ **Stable Keys:** Not applicable (field in post_creation0 body, not in replace_triggers_external_values)
✅ **Deferred Work Completion:** No following.md exists - no deferred work to complete
✅ **Deferred Work Recording:** No deferrals made by this task
✅ **Edge Cases:** All edge cases properly analyzed and handled (boundary values, null semantics, idempotency)
✅ **Scope Compliance:** Only implemented Task #11 field, no content from other tasks added

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. The field is correctly:
- Assigned at `properties.ttl` path in post_creation0 phase (verified with Go code evidence)
- Configured with default value 3600 using the PREFERRED `optional(number, default)` syntax
- Validated with range [0, 2147483647] matching provider's `IntBetween(0, math.MaxInt32)`
- Integrated into the SOA record creation flow after primary zone creation

No deviations, simplifications, or "safer alternatives" were found. The implementation matches the provider's exact behavior including default handling, validation rules, and assignment phase.

**Status:** APPROVED ✅

---
