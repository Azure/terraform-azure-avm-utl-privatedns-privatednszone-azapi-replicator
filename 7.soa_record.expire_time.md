# Task #7 - soa_record.expire_time

## Summary
Implemented the `expire_time` field within the `soa_record` block as an optional number field with a default value of 2419200 and validation requiring a minimum value of 0. The field maps to `body.properties.soaRecord.expireTime` in the post-creation SOA record update operation.

## Shadow Implementation
```hcl
# In variables.tf
variable "soa_record" {
  type = object({
    expire_time  = optional(number, 2419200) # <-
    # ... other fields ...
  })
  
  validation { # <-
    condition = var.soa_record == null || ( # <-
      var.soa_record.expire_time >= 0 # <-
    )
    error_message = "The `expire_time` must be at least 0." # <-
  }
}

# In migrate_main.tf
locals {
  post_creation0 = var.soa_record != null ? {
    body = {
      properties = {
        soaRecord = {
          expireTime = var.soa_record.expire_time # <-
        }
      }
    }
  } : null
}
```

## Create Phase Verification

### Pattern: Post-Creation Operation
The `expire_time` field is part of the SOA record, which is handled as a post-creation operation after the primary zone creation.

### Evidence from Create Method
From `resourcePrivateDnsZoneCreateUpdate`:

```go
// Phase 1: Primary zone creation
if err := client.CreateOrUpdateThenPoll(ctx, id, parameters, options); err != nil {
    return fmt.Errorf("creating/updating %s: %s", id, err)
}

// Phase 2: SOA record post-creation operation
if v, ok := d.GetOk("soa_record"); ok {
    soaRecordRaw := v.([]interface{})[0].(map[string]interface{})
    soaRecord := expandPrivateDNSZoneSOARecord(soaRecordRaw)  // <-- expire_time field expanded here
    rsParameters := privatedns.RecordSet{
        Properties: &privatedns.RecordSetProperties{
            Ttl:       pointer.To(int64(soaRecordRaw["ttl"].(int))),
            Metadata:  tags.Expand(soaRecordRaw["tags"].(map[string]interface{})),
            SoaRecord: soaRecord,  // <-- soaRecord struct contains expireTime
        },
    }

    recordId := privatedns.NewRecordTypeID(id.SubscriptionId, id.ResourceGroupName, id.PrivateDnsZoneName, privatedns.RecordTypeSOA, "@")

    if _, err := recordSetsClient.RecordSetsCreateOrUpdate(ctx, recordId, rsParameters, createOptions); err != nil {
        return fmt.Errorf("creating/updating %s: %s", recordId, err)
    }
}
```

### SDK Function Classification
- **Operation**: `recordSetsClient.RecordSetsCreateOrUpdate()` - CreateOrUpdate function
- **Classification**: Post-creation operation → `post_creation0`
- **Resource Type**: `Microsoft.Network/privateDnsZones/SOA@2024-06-01`

### Decision
The `expire_time` field is implemented in `local.post_creation0.body.properties.soaRecord.expireTime` because it's processed in the post-creation SOA record update operation, not during the primary zone creation.

## Assignment Path Verification

### Predicted Path
`body.properties.soaRecord.expireTime`

### Go Code Evidence

From `expandPrivateDNSZoneSOARecord`:
```go
func expandPrivateDNSZoneSOARecord(input map[string]interface{}) *privatedns.SoaRecord {
    return &privatedns.SoaRecord{
        Email:       pointer.To(input["email"].(string)),
        ExpireTime:  pointer.To(int64(input["expire_time"].(int))),  // <-- expire_time extracted from input
        MinimumTtl:  pointer.To(int64(input["minimum_ttl"].(int))),
        RefreshTime: pointer.To(int64(input["refresh_time"].(int))),
        RetryTime:   pointer.To(int64(input["retry_time"].(int))),
    }
}
```

From Create method:
```go
rsParameters := privatedns.RecordSet{
    Properties: &privatedns.RecordSetProperties{  // <-- Properties assignment
        SoaRecord: soaRecord,  // <-- soaRecord nested under Properties
    },
}
```

### Assignment Trace
1. `input["expire_time"]` → `SoaRecord.ExpireTime`
2. `SoaRecord` → `RecordSetProperties.SoaRecord`
3. `RecordSetProperties` → `RecordSet.Properties`
4. Final Azure API path: `body.properties.soaRecord.expireTime`

### Verified Path
✅ **Match**: The predicted path `body.properties.soaRecord.expireTime` matches the verified assignment trace through the Go code.

## Provider Schema

### Schema Definition
From the resource schema:
```go
"expire_time": {
    Type:         pluginsdk.TypeInt,
    Optional:     true,
    Default:      2419200,
    ValidateFunc: validation.IntAtLeast(0),
},
```

### Key Properties
- **Type**: Int
- **Optional**: true
- **Default**: 2419200 (28 days in seconds)
- **Computed**: false
- **ForceNew**: Inherited from parent block (`soa_record` has `ForceNew: true`)
- **ValidateFunc**: `validation.IntAtLeast(0)` - must be at least 0

## Azure API Schema

### Property Path
`body.properties.soaRecord.expireTime`

### Azure API Type
From query result:
```
"expireTime":Number
```

### Azure API Documentation
"The expire time for this SOA record."

The expire time is typically the duration after which a secondary DNS server should stop answering queries if it cannot reach the primary server.

## Hidden Fields Check

### Analysis
No hidden fields. The `expire_time` field directly maps from schema to API with no additional transformations or hidden values.

## Mapping (snake_case → camelCase)

| Schema Field | API Field | Notes |
|--------------|-----------|-------|
| `expire_time` | `expireTime` | Standard camelCase conversion |

## Special Handling

### 1. Default Value Implementation
The provider schema specifies `Default: 2419200` (28 days in seconds).

**Implementation in `variables.tf`:**
The default is implemented using Terraform's `optional()` type constructor:

```hcl
expire_time = optional(number, 2419200)
```

This exactly replicates the provider's default behavior:
- When `expire_time` is not provided in the `soa_record` block, it defaults to `2419200`
- When explicitly set, the provided value is used
- The default is applied at the variable level, matching where the provider applies it

### 2. Validation Implementation
The provider uses `validation.IntAtLeast(0)`, which ensures the value is at least 0.

**Implementation in `variables.tf`:**
```hcl
validation {
  condition = var.soa_record == null || (
    var.soa_record.expire_time >= 0
  )
  error_message = "The `expire_time` must be at least 0."
}
```

**Rationale**:
- Guard condition `var.soa_record == null` allows the entire block to be absent
- Direct comparison `>= 0` exactly replicates the `IntAtLeast(0)` validation
- Error message clearly describes the constraint

### 3. ForceNew Behavior
The `expire_time` field inherits ForceNew behavior from the parent `soa_record` block (which has `ForceNew: true`). This is already handled at the block level in Task #5's `replace_triggers_external_values`.

No additional ForceNew tracking is needed for individual fields within the block.

### 4. Type Conversion
The provider schema defines the field as `TypeInt`, and the expand function converts it to `int64`:

```go
ExpireTime: pointer.To(int64(input["expire_time"].(int)))
```

In Terraform, the variable is defined as `number` type. Terraform will handle the conversion automatically when passing to the AzAPI provider, which expects numeric values in JSON format. No explicit conversion is needed in our implementation.

## Deferred Work Completion

### No Deferred Work
Checked `following.md` - file does not exist. No work was deferred to this task.

### Work Deferred FROM This Task
None. All logic for the `expire_time` field has been implemented in this task, including default value and validation.

## Edge Case Analysis

### Null Semantics
- **`var.soa_record == null`**: expire_time field is not evaluated; post-creation operation is skipped
- **`var.soa_record != null && expire_time not specified`**: Defaults to `2419200` (via `optional()` type constructor)
- **`var.soa_record.expire_time == 0`**: Valid - minimum allowed value

### Boundary Conditions
- **Minimum value**: `0` (allowed, validated) ✅
- **Default value**: `2419200` (28 days) ✅
- **Maximum value**: No explicit maximum in provider validation; limited by int64 range in Go
- **Negative values**: Invalid - caught by validation (`>= 0`) ✅

### Common Values
- **0**: Minimum allowed, rare in practice but technically valid
- **2419200** (28 days): Default value, common for expire times
- **604800** (7 days): Common alternative
- **1209600** (14 days): Another common value

### Idempotency
- ✅ expire_time value directly assigned from variable
- ✅ No order-dependent operations
- ✅ No transformations that could produce different results on re-apply
- ✅ Default value applied consistently via `optional()` type constructor

### Safe References
- ✅ `var.soa_record.expire_time` only accessed when `var.soa_record != null` (checked in parent conditional)
- ✅ Validation condition checks `var.soa_record == null` first
- ✅ No nested field access without null guards

## Critical Review

### Exact Provider Behavior Replication
✅ **Default value**: Exactly matches provider's `Default: 2419200` via `optional(number, 2419200)`
✅ **Validation**: Exactly replicates `validation.IntAtLeast(0)` with `>= 0` condition
✅ **Assignment path**: Correct path `body.properties.soaRecord.expireTime` in post-creation operation
✅ **Type handling**: Number type correctly maps to Go's int64 conversion

### Validation Comparison
| Provider Rule | Terraform Implementation | Match |
|---------------|--------------------------|-------|
| `IntAtLeast(0)` | `var.soa_record.expire_time >= 0` | ✅ |
| Default: 2419200 | `optional(number, 2419200)` | ✅ |

### No Simplified/Conservative Approaches
- ❌ Did NOT skip validation
- ❌ Did NOT use a different default value
- ❌ Did NOT defer validation to Azure API
- ✅ Implemented exact default and validation from provider

### Completeness
- ✅ Field added to correct location in `post_creation0.body.properties.soaRecord`
- ✅ Default value implemented via `optional()` type constructor
- ✅ Validation implemented in `variables.tf`
- ✅ No hidden fields to handle
- ✅ No sensitive field handling needed
- ✅ ForceNew handled by parent block

## Checklist

- ✅ Property in correct local (`post_creation0.body.properties.soaRecord.expireTime`)
- ✅ ForceNew handled by parent block (no individual field wrapping needed)
- ✅ All logic exactly replicated from provider (default value + validation)
- ✅ Validations IMPLEMENTED in variables.tf (MANDATORY - IntAtLeast(0))
- ✅ No TODO comment needed (not sensitive field migration)
- ✅ Hidden fields checked - none found
- ✅ No deferred work in following.md (file doesn't exist)
- ✅ No deferred work from following.md (file doesn't exist)
- ✅ Critical review completed - null safety, edge cases, exact validation replication verified
- ✅ Edge Case Analysis included
- ✅ Proof document created
- ✅ Ready to update track.md to "Pending for check"
- ✅ Self-Review: Only expire_time field implementation added, no other fields, no content from other tasks

## Test Cases

### Valid Inputs
```hcl
# Using default value
soa_record = { email = "admin.contoso.com" }
# expire_time defaults to 2419200

# Explicit default
soa_record = { 
  email = "admin.contoso.com"
  expire_time = 2419200 
}

# Minimum value
soa_record = { 
  email = "admin.contoso.com"
  expire_time = 0 
}

# Common values
soa_record = { 
  email = "admin.contoso.com"
  expire_time = 604800  # 7 days
}

soa_record = { 
  email = "admin.contoso.com"
  expire_time = 1209600  # 14 days
}

soa_record = { 
  email = "admin.contoso.com"
  expire_time = 3628800  # 42 days
}
```

### Invalid Inputs (Should Fail Validation)
```hcl
# Negative value
soa_record = { 
  email = "admin.contoso.com"
  expire_time = -1  # Fails: must be at least 0
}

soa_record = { 
  email = "admin.contoso.com"
  expire_time = -3600  # Fails: must be at least 0
}
```

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2025-12-23
**Task:** #7 - soa_record.expire_time

### Validation Results

✅ **ForceNew Logic:** No individual field ForceNew needed - correctly inherits from parent block (soa_record)
✅ **Stable Keys:** Not applicable - field is part of post-creation operation body
✅ **Phase Detection:** Field correctly placed in `post_creation0.body.properties.soaRecord.expireTime`
✅ **Type Conversion:** Correct conversion from `optional(number, 2419200)` to API number type
✅ **Null Handling:** Correctly handled via parent block conditional (`var.soa_record != null`)
✅ **Validations:** Exact replication of `validation.IntAtLeast(0)` implemented in variables.tf
✅ **Default Value:** Exact replication using preferred `optional(number, 2419200)` method (not fallback coalesce)
✅ **Deferred Work Completion:** No deferred work for this task (following.md does not exist)
✅ **Deferred Work Recording:** No deferrals made by this task
✅ **Edge Cases:** Comprehensive analysis including null semantics, boundary conditions (0, negative values), and idempotency verification

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`:
- Default value `2419200` implemented via preferred `optional()` method (executor.md line 148)
- Validation `IntAtLeast(0)` replicated exactly as `>= 0` condition (executor.md line 123)
- Assignment path correctly traced through Go code to `properties.soaRecord.expireTime`
- Post-creation operation placement verified with Create method evidence
- No deviations, simplifications, or "safer alternatives" found

**Status:** APPROVED ✅

---
